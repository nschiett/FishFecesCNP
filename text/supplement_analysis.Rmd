---
title: "Supplemental analysis"
author: "N.S."
date: "15 March 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(brms)
drake::loadd(result_ext)
```
## Introduction

In this document, we show the results of testing two hypotheses: 
1) The higher the cnp% content of the diet, the higher the difference between diet and feces content. 
2) Nutrient balancing in digestive tract. Higher probability of elevated absorption of N relative to carbon if N in diet is low

```{r, include = FALSE, cache=TRUE}
fit1c <- brm(log(Rc_mean) ~ log(Dc_mean), data = result_ext)
fit1n <- update(fit1c, formula = log(Rn_mean) ~ log(Dn_mean), newdata = result_ext)
fit1p <- update(fit1c, formula = log(Rp_mean) ~ log(Dp_mean), newdata = result_ext)
```

```{r, include = FALSE, cache = TRUE}

testn <- result_ext %>%
  filter(Acn_lqr>1 |Acn_uqr<1) %>%
  mutate(Acn = as.numeric( Acn_mean < 1))
testp <- result_ext %>%
  filter(Acp_lqr>1 |Acp_uqr<1) %>%
  mutate(Acp = as.numeric( Acp_mean < 1))
ggplot(testn) +
  geom_boxplot(aes(x = as.character(Acn), y = Dn_mean)) +
  geom_jitter(aes(x = as.character(Acn), y = Dn_mean))

ggplot(testp) +
  geom_boxplot(aes(x = as.character(Acp), y = Dp_mean)) +
  geom_jitter(aes(x = as.character(Acp), y = Dp_mean))

fit2n <- brm(Acn ~ log(Dn_mean), data = testn, family = "bernoulli")
fit2p <- update(fit2n, formula = Acp ~ log(Dp_mean), newdata = testp)
```


## Hypothesis 1
We indeed find that diet quality increases absorption. 


```{r, echo = FALSE, results = 'asis'}
knitr::kable(round(fixef(fit1c), 3), caption = "Model Wc:Dc")
knitr::kable(round(fixef(fit1n), 3), caption = "Model Wn:Dn")
knitr::kable(round(fixef(fit1p), 3), caption = "Model Wp:Dp")

```


```{r, echo = FALSE, fig.width = 8, fig.height=10}
library(latex2exp)

dat <- conditional_effects(fit1c)[[1]]

p1 <-
ggplot(result_ext) +
  geom_ribbon(aes(x = Dc_mean, ymin = lower__, ymax = upper__), 
              data = dat, alpha = 0.3) +
  geom_line(aes(x = Dc_mean, y = estimate__), 
              data = dat, alpha = 0.8) +
  geom_point(aes(x = (Dc_median), y = log(Rc_median))) +
  theme_bw() +
  labs(x = "Dc (%)", y = TeX("$log(\\frac{Wc}{Dc})$" ))
 
dat <- conditional_effects(fit1n)[[1]]

p2 <-
ggplot(result_ext) +
  geom_ribbon(aes(x = Dn_mean, ymin = lower__, ymax = upper__), 
              data = dat, alpha = 0.3) +
  geom_line(aes(x = Dn_mean, y = estimate__), 
              data = dat, alpha = 0.8) +
  geom_point(aes(x = (Dn_median), y = log(Rn_median))) +
  theme_bw() +
  labs(x = "Dn (%)", y = TeX("$log(\\frac{Wn}{Dn})$" ))

dat <- conditional_effects(fit1p)[[1]]
p3 <-
ggplot(result_ext) +
  geom_ribbon(aes(x = Dp_mean, ymin = lower__, ymax = upper__), 
              data = dat, alpha = 0.3) +
  geom_line(aes(x = Dp_mean, y = estimate__), 
              data = dat, alpha = 0.8) +
  geom_point(aes(x = (Dp_median), y = log(Rp_median))) +
  theme_bw() +
  labs(x = "Dp (%)", y = TeX("$log(\\frac{Wp}{Dp})$" ))
library(patchwork)
p1 + p2 + p3 + plot_layout(nrow = 3)
```

## Hypothesis 2
No proof for post-digestive nutrient balancing. 

```{r, echo = FALSE, results = 'asis'}
knitr::kable(round(fixef(fit2n), 3), caption = "Model absorption n>c")
knitr::kable(round(fixef(fit2p), 3), caption = "Model absorption p>c")

```

```{r echo = FALSE}
dat <- conditional_effects(fit2n)[[1]] 
  ggplot(dat) +
  geom_ribbon(aes(x = Dn_mean, ymin = lower__, ymax = upper__), 
              data = dat, alpha = 0.3) +
  geom_line(aes(x = Dn_mean, y = estimate__), 
              data = dat, alpha = 0.8) +
  labs(y ="Probability absorption N > absorpion C", x = "Diet N%") +
    theme_bw()
  
  dat <- conditional_effects(fit2p)[[1]] 
  ggplot(dat) +
  geom_ribbon(aes(x = Dp_mean, ymin = lower__, ymax = upper__), 
              data = dat, alpha = 0.3) +
  geom_line(aes(x = Dp_mean, y = estimate__), 
              data = dat, alpha = 0.8) +
  labs(y ="Probability absorption P > absorpion C", x = "Diet P%") +
    theme_bw()
  
```




